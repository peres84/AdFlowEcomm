# Video Generation API

## Overview

The video generation API provides endpoints for parallel video scene generation using the Runware SDK. Videos are generated asynchronously in the background, allowing the frontend to poll for progress updates.

## Endpoints

### POST /api/videos/generate-scenes

Initiates parallel video generation for all approved scene descriptions.

**Request:**
```json
{
  "session_id": "uuid-string"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Video generation started for 4 scenes",
  "job_id": "uuid-string"
}
```

**Requirements:**
- Session must exist and be valid
- Scene descriptions must be generated (4 scenes: hook, problem, solution, cta)

### GET /api/videos/status/{job_id}

Gets the current status of a video generation job. Poll this endpoint to track progress.

**Response:**
```json
{
  "job_id": "uuid-string",
  "overall_status": "generating",
  "scenes": [
    {
      "scenario": "hook",
      "status": "completed",
      "progress": 100,
      "video_url": "/outputs/session_hook_abc123.mp4",
      "error": null
    },
    {
      "scenario": "problem",
      "status": "generating",
      "progress": 45,
      "video_url": null,
      "error": null
    }
  ]
}
```

**Status Values:**
- `generating`: Video is being generated
- `completed`: Video generation successful
- `failed`: Video generation failed
- `partial`: Some videos completed, some failed

**Overall Status:**
- `generating`: At least one video is still generating
- `completed`: All videos completed successfully
- `failed`: All videos failed
- `partial`: Mix of completed and failed videos

### POST /api/videos/regenerate-scene

Regenerates a single video scene using the existing scene description.

**Request:**
```json
{
  "session_id": "uuid-string",
  "scenario": "hook"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Video regenerated successfully for hook",
  "video_url": "/outputs/session_hook_xyz789.mp4",
  "scenario": "hook"
}
```

## Implementation Details

### Parallel Generation

The video service uses `asyncio.gather()` to generate all four video scenes in parallel:

1. Creates a job with unique ID
2. Spawns async tasks for each scene
3. Each task independently:
   - Connects to Runware API
   - Sends video inference request
   - Polls for completion (handled by SDK)
   - Downloads video to local storage
   - Updates job status

### Progress Tracking

Progress is tracked at multiple levels:
- **10%**: Request created
- **30%**: Request sent to Runware
- **70%**: Video generated by Runware
- **80%**: Video downloaded
- **100%**: Complete

### Video Storage

Videos are:
1. Generated by Runware API (returns URL)
2. Downloaded to `backend/outputs/` directory
3. Served via FastAPI static files at `/outputs/`
4. Named: `{session_id}_{scenario}_{random}.mp4`

### Session Integration

When a job completes (all scenes done), the video URLs are automatically stored in the session's `scene_videos` list for later retrieval.

## Error Handling

- Individual scene failures don't stop other scenes
- Failed scenes are marked with status "failed" and error message
- Overall job status reflects partial completion
- Retry is available via regenerate endpoint

## Usage Example

```python
# 1. Start generation
response = await client.post("/api/videos/generate-scenes", json={
    "session_id": "abc-123"
})
job_id = response.json()["job_id"]

# 2. Poll for status
while True:
    status = await client.get(f"/api/videos/status/{job_id}")
    data = status.json()
    
    if data["overall_status"] in ["completed", "failed", "partial"]:
        break
    
    await asyncio.sleep(5)  # Poll every 5 seconds

# 3. Get video URLs from session
session = await client.get(f"/api/session/{session_id}")
videos = session.json()["scene_videos"]
```
